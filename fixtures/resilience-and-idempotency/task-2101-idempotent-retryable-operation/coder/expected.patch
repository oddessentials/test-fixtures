diff --git a/src/services/payment.ts b/src/services/payment.ts
index ...
--- a/src/services/payment.ts
+++ b/src/services/payment.ts
@@ -1,11 +1,24 @@
+const idempotencyStore = new Map<string, any>();
+
 export async function processPayment(amount: number, idempotencyKey: string) {
+  if (idempotencyStore.has(idempotencyKey)) {
+    return idempotencyStore.get(idempotencyKey);
+  }
+
   // Call external API
-  const response = await fetch('https://api.gateway.com/charge', {
-    method: 'POST',
-    body: JSON.stringify({ amount })
-  });
-  if (!response.ok) {
-    throw new Error('Payment failed');
+  let response;
+  for (let i = 0; i < 3; i++) {
+    response = await fetch('https://api.gateway.com/charge', {
+      method: 'POST',
+      body: JSON.stringify({ amount })
+    });
+    if (response.ok || response.status < 500) break;
+    if (i === 2) throw new Error('Payment failed after retries');
   }
-  return response.json();
+
+  if (!response || !response.ok) throw new Error('Payment failed');
+
+  const result = await response.json();
+  idempotencyStore.set(idempotencyKey, result);
+  return result;
 }
diff --git a/src/tests/payment.test.ts b/src/tests/payment.test.ts
index ...
--- a/src/tests/payment.test.ts
+++ b/src/tests/payment.test.ts
@@ -4,4 +4,7 @@ describe('Payment Service', () => {
   it('charges the card', async () => {
     // mock fetch
   });
+  it('is idempotent', async () => {
+    // test
+  });
 });
